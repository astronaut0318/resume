# 网关模块开发指南

## 一、模块介绍

网关模块是简历系统的统一入口，负责请求的路由分发、身份认证、限流熔断等功能。作为微服务架构的重要组成部分，网关模块能够提供给前端统一的API调用地址，并实现对其他微服务的保护。

## 二、技术选型

- Spring Boot 2.7.14
- Spring Cloud 2021.0.8
- Spring Cloud Gateway: API网关
- Spring Cloud Alibaba Nacos: 服务注册发现、配置中心
- Spring Cloud Alibaba Sentinel: 流量控制、熔断降级
- JWT: 用户认证
- Redis: 缓存、令牌存储
- Jackson: JSON处理
- Swagger: 接口文档管理

## 三、目录结构

```
gateway-service/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── ptu/
│   │   │           ├── GatewayServiceApplication.java     # 启动类
│   │   │           └── gateway/
│   │   │               ├── config/                        # 配置类
│   │   │               │   ├── GatewayConfig.java         # 网关基础配置
│   │   │               │   ├── SwaggerConfig.java         # Swagger配置
│   │   │               │   └── RedisConfig.java           # Redis配置
│   │   │               ├── filter/                        # 过滤器
│   │   │               │   ├── AuthenticationFilter.java  # 认证过滤器
│   │   │               │   ├── SwaggerHeaderFilter.java   # Swagger头信息处理过滤器
│   │   │               │   └── RequestLogFilter.java      # 请求日志过滤器
│   │   │               ├── handler/                       # 处理器
│   │   │               │   └── GlobalExceptionHandler.java # 全局异常处理器
│   │   │               └── util/                          # 工具类
│   │   │                   └── JwtUtils.java              # JWT工具类
│   │   └── resources/
│   │       ├── application.yml                           # 应用配置
│   │       └── bootstrap.yml                             # 引导配置
│   └── test/                                             # 测试目录
└── pom.xml                                               # 项目依赖
```

## 四、功能说明

### 1. 路由转发

网关根据请求路径前缀将请求转发到对应的微服务，所有API遵循RESTful规范，统一使用`/api`作为根路径：

| 服务名称 | 路由前缀 | 描述 |
| ---- | ---- | ---- |
| user-service | /api/users | 用户服务 |
| auth-service | /api/auth | 认证服务 |
| file-service | /api/files | 文件服务 |
| order-service | /api/orders | 订单服务 |
| template-service | /api/templates | 模板服务 |
| resume-service | /api/resumes | 简历服务 |
| ai-service | /api/ai | AI服务 |
| notification | /api/notifications | 通知服务 |
| user-service | /api/admin | 管理员API |
| gateway-service | /api/status, /api/config/refresh | 系统状态和配置 |

### 2. 身份认证

- 基于JWT的认证机制，使用Base64编码的安全密钥
- 白名单路径可直接访问（如登录、注册等）
- 对需要认证的接口进行Token验证
- Redis存储和管理有效的Token
- 统一的授权失败响应格式

### 3. 跨域配置

- 支持跨域请求
- 允许指定的域名来源：
  - `http://localhost:8080`（前端开发服务器）
  - `http://localhost:3000`（前端开发服务器备选端口）
  - `https://*.ptu.com`（生产环境域名）
- 允许的HTTP方法：GET、POST、PUT、DELETE、OPTIONS
- 允许携带凭证（Credentials）

### 4. 限流熔断

- 基于Sentinel的限流配置
- 基于请求IP的限流策略
- 熔断降级机制，防止服务雪崩
- 统一的限流响应格式

### 5. 日志记录

- 记录请求日志
- 请求响应时间统计
- 异常统一处理

### 6. 统一响应格式

所有API接口均使用统一的响应格式：

```json
{
  "code": 200,       // 状态码：200成功，其他表示失败
  "message": "操作成功", // 消息描述
  "data": {}         // 返回数据，可能是对象、数组或null
}
```

### 7. Swagger文档集成

- 网关集成Swagger文档，提供统一的API文档访问入口
- 聚合所有微服务的Swagger文档
- 统一访问地址：`http://localhost:8000/swagger-ui.html`或`http://localhost:8000/doc.html`
- 白名单路径配置，确保Swagger相关路径可以不经过身份验证直接访问

微服务Swagger路径白名单：
```
/swagger-resources/**
/webjars/**
/v2/api-docs
/v3/api-docs
/swagger-ui.html
/doc.html
```

## 五、接口说明

网关本身不直接提供业务接口，而是将请求转发到各个微服务。主要提供以下功能：

1. 请求路由
2. 请求认证
3. 限流熔断
4. 跨域支持
5. 统一异常处理
6. API文档聚合

## 六、部署配置

### 1. 端口

- 网关服务端口：8000

### 2. 依赖服务

- Nacos服务：127.0.0.1:8848
- Redis服务：127.0.0.1:6379
- Sentinel控制台：localhost:8858

## 七、常见问题及解决方案

### 1. Swagger UI 401未授权错误

**问题**：通过网关访问Swagger UI时返回401未授权错误。

**解决方案**：
- 在认证过滤器中添加Swagger相关路径到白名单
- 确保SwaggerHeaderFilter过滤器正确配置，处理Swagger请求头
- 检查网关配置，确保正确转发Swagger相关请求

### 2. Bean冲突问题

**问题**："serverCodecConfigurer"被重复定义。

**解决方案**：
- 移除WebConfig中的重复Bean定义
- 在应用配置中添加`spring.main.allow-bean-definition-overriding=true`允许Bean定义覆盖

### 3. 过滤器命名问题

**问题**：找不到"SwaggerHeader"过滤器。

**解决方案**：
- 确保过滤器类名与文件名一致
- 在Spring Cloud Gateway中，过滤器工厂类名需要遵循命名规范：类名应为`XxxGatewayFilterFactory`
- 配置文件中引用时使用的名称应为去掉`GatewayFilterFactory`后缀的部分

## 八、开发进度

- [x] 项目基础结构搭建
- [x] 网关路由配置
- [x] 认证过滤器开发
- [x] 全局异常处理
- [x] 请求日志记录
- [x] 跨域配置
- [x] 限流配置
- [x] 统一响应格式
- [x] JWT安全配置优化
- [x] Swagger文档集成
- [x] 常见问题解决方案完善
- [ ] 监控指标整合
- [ ] 单元测试编写
- [ ] 集成测试编写 