# 文档模块开发指南

## 一、模块介绍

文档模块是简历系统的核心支持组件，基于OnlyOffice实现文档的在线预览与编辑功能。本模块提供统一的文档访问接口，支持模板、简历和通用文件的在线预览和编辑，并提供文档版本管理功能。

## 二、技术选型

- Spring Boot 2.7.14
- Spring Cloud 2021.0.8
- MyBatis Plus 3.5.2
- Redis 6.0+
- MinIO 对象存储
- MySQL 8.0.28
- OnlyOffice Document Server 7.3.3+
- JWT 0.11.5
- Knife4j/Swagger 接口文档

## 三、目录结构

```
document-service/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── ptu/
│   │   │           └── document/
│   │   │               ├── DocumentServiceApplication.java  # 启动类
│   │   │               ├── common/                          # 公共类
│   │   │               │   ├── constants/                   # 常量定义
│   │   │               │   └── utils/                       # 工具类
│   │   │               ├── config/                          # 配置类
│   │   │               ├── controller/                      # 控制器
│   │   │               ├── entity/                          # 实体类
│   │   │               ├── mapper/                          # Mapper接口
│   │   │               ├── service/                         # 服务接口
│   │   │               │   └── impl/                        # 服务实现
│   │   │               ├── dto/                             # 数据传输对象
│   │   │               └── vo/                              # 视图对象
│   │   └── resources/
│   │       ├── application.yml                             # 应用配置
│   │       ├── bootstrap.yml                               # 引导配置
│   │       └── document_tables.sql                         # 数据库脚本
│   └── test/                                               # 测试目录
└── pom.xml                                                # 项目依赖
```

## 四、功能说明

### 1. 文档在线预览

- 基于OnlyOffice实现文档在线预览
- 支持模板、简历和通用文件的预览
- 自动识别文件类型，适配不同的文档格式

### 2. 文档在线编辑

- 基于OnlyOffice实现文档在线编辑
- 实时保存编辑内容
- 提供协同编辑功能

### 3. 文档版本管理

- 自动保存文档历史版本
- 支持查看和下载历史版本
- 支持版本比较和回滚

### 4. 文件存储

- 基于MinIO实现文档对象存储
- 文档元数据与文件内容分离
- 支持大文件存储和管理

## 五、配置说明

### 1. OnlyOffice配置

OnlyOffice Document Server是一个独立的服务，需要单独部署。配置信息位于`application.yml`：

```yaml
# OnlyOffice配置
onlyoffice:
  document-server-url: http://localhost:8085
  callback-url: http://localhost:9000/api/documents/callback
  jwt-secret: your_secure_jwt_secret
  token-ttl: 300 # 秒
  document:
    storage-path: documents
    versions-enabled: true
    max-versions: 10  # 每个文档最多保存的历史版本数
```

### 2. MinIO配置

项目使用MinIO作为对象存储服务，用于存储文档文件。配置信息位于`application.yml`：

```yaml
# MinIO配置
minio:
  endpoint: http://127.0.0.1:9090
  access-key: ZMlUgS6Z3d4raCN3pVeT
  secret-key: VOHLtWjk1WBFdiCpG06VPVTVgKsSp5Nl9w2D8vg8
  bucket:
    document: resume-documents  # 文档存储桶
    version: resume-document-versions  # 版本存储桶
```

## 六、接口说明

### 1. 获取文档编辑器配置

```http
GET /documents/{sourceType}/{sourceId}/config?mode=view&userId=1&userName=admin
```

- 根据来源类型和ID，获取文档编辑器配置
- 支持view（查看）、edit（编辑）、comment（评论）三种模式
- 返回OnlyOffice编辑器所需的配置信息

### 2. 创建文档版本

```http
POST /documents/{sourceType}/{sourceId}/versions?userId=1
```

- 手动创建文档版本
- 每次编辑保存后，系统会自动创建新版本

### 3. 获取文档版本列表

```http
GET /documents/{sourceType}/{sourceId}/versions
```

- 获取指定文档的所有历史版本

### 4. 预览文档版本

```http
GET /documents/versions/{versionId}/preview?userId=1&userName=admin
```

- 在线预览指定版本的文档

### 5. 下载文档

```http
GET /documents/{sourceType}/{sourceId}/download
```

- 下载最新版本的文档

### 6. 下载文档版本

```http
GET /documents/versions/{versionId}/download
```

- 下载指定版本的文档

## 七、部署说明

### 1. 前置条件

- JDK 1.8+
- MySQL 8.0+
- Redis 6.0+
- MinIO Server
- OnlyOffice Document Server

### 2. MinIO部署

```bash
# 使用Docker部署MinIO
docker run -p 9001:9000 -p 9000:9001 \
  --name minio \
  -d \
  -e "MINIO_ROOT_USER=minioadmin" \
  -e "MINIO_ROOT_PASSWORD=minioadmin" \
  -v /data/minio/data:/data \
  minio/minio server /data --console-address ":9001"
```

### 3. OnlyOffice部署

```bash
# 使用Docker部署OnlyOffice Document Server
docker run -i -t -d -p 8085:80 \
  --restart=always \
  --name onlyoffice \
  -e JWT_ENABLED=true \
  -e JWT_SECRET=your_secure_jwt_secret \
  -v /app/onlyoffice/data:/var/www/onlyoffice/Data \
  -v /app/onlyoffice/logs:/var/log/onlyoffice \
  onlyoffice/documentserver
```

### 4. 数据库初始化

执行`document_tables.sql`脚本创建所需的数据库表。

### 5. 服务启动

```bash
# 打包
mvn clean package -DskipTests

# 启动
java -jar document-service.jar
```

## 八、客户端集成示例

### 1. 前端集成

```javascript
// 文档编辑器组件示例
<template>
  <div ref="editorContainer" style="height: 800px;"></div>
</template>

<script>
export default {
  props: {
    sourceType: String,
    sourceId: Number,
    mode: {
      type: String,
      default: 'view'
    },
    userId: Number,
    userName: String
  },
  async mounted() {
    // 加载OnlyOffice JS API
    await this.loadScript(`${window.onlyofficeServerUrl}/web-apps/apps/api/documents/api.js`);
    
    // 获取编辑器配置
    const response = await fetch(
      `/api/documents/${this.sourceType}/${this.sourceId}/config?mode=${this.mode}&userId=${this.userId}&userName=${this.userName}`
    );
    const result = await response.json();
    
    if (result.code === 200) {
      // 初始化编辑器
      new DocsAPI.DocEditor(this.$refs.editorContainer, result.data);
    }
  },
  methods: {
    loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
  }
}
</script>
```

### 2. 版本管理集成

```javascript
// 版本列表组件示例
<template>
  <div>
    <h3>版本历史</h3>
    <ul>
      <li v-for="version in versions" :key="version.id">
        版本 {{ version.version }} 
        ({{ formatDate(version.createTime) }})
        <button @click="previewVersion(version.id)">预览</button>
        <button @click="downloadVersion(version.id)">下载</button>
      </li>
    </ul>
    <button @click="createVersion">创建新版本</button>
  </div>
</template>

<script>
export default {
  props: {
    sourceType: String,
    sourceId: Number,
    userId: Number
  },
  data() {
    return {
      versions: []
    }
  },
  async mounted() {
    await this.loadVersions();
  },
  methods: {
    async loadVersions() {
      const response = await fetch(`/api/documents/${this.sourceType}/${this.sourceId}/versions`);
      const result = await response.json();
      if (result.code === 200) {
        this.versions = result.data;
      }
    },
    async createVersion() {
      const response = await fetch(
        `/api/documents/${this.sourceType}/${this.sourceId}/versions?userId=${this.userId}`,
        { method: 'POST' }
      );
      const result = await response.json();
      if (result.code === 200) {
        await this.loadVersions();
      }
    },
    previewVersion(versionId) {
      window.open(`/document/version/${versionId}?userId=${this.userId}`);
    },
    downloadVersion(versionId) {
      window.location.href = `/api/documents/versions/${versionId}/download`;
    },
    formatDate(dateStr) {
      return new Date(dateStr).toLocaleString();
    }
  }
}
</script>
```

## 九、开发进度

- [x] 项目基础结构搭建
- [x] MinIO集成
- [x] OnlyOffice集成
- [x] 文档预览功能
- [x] 文档编辑功能
- [x] 文档版本管理
- [x] 文档下载功能
- [ ] 单元测试编写
- [ ] 集成测试编写
- [ ] 性能优化 