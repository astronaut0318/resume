# 认证模块开发指南

## 一、模块介绍

认证模块是简历系统的核心安全模块，负责用户的认证授权管理，包括用户登录、令牌刷新、登出和密码修改等功能。本模块与用户模块紧密配合，通过Feign客户端远程调用用户服务完成相关功能。

## 二、技术选型

- Spring Boot 2.7.14
- Spring Cloud 2021.0.8
- Spring Cloud Alibaba 2021.0.4.0
- Nacos：服务注册与配置中心
- OpenFeign：服务间调用
- JWT 0.11.5：认证令牌
- Redis：缓存令牌
- Swagger：API文档

## 三、目录结构

```
auth-service/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── ptu/
│   │   │           ├── AuthServiceApplication.java  # 启动类
│   │   │           └── auth/
│   │   │               ├── config/                  # 配置类
│   │   │               │   └── RedisConfig.java
│   │   │               ├── controller/              # 控制器层
│   │   │               │   └── AuthController.java
│   │   │               ├── dto/                     # 数据传输对象
│   │   │               │   ├── LoginDTO.java
│   │   │               │   ├── RefreshTokenDTO.java
│   │   │               │   └── ChangePasswordDTO.java
│   │   │               ├── entity/                  # 实体类
│   │   │               │   └── UserVO.java
│   │   │               ├── feign/                   # Feign客户端
│   │   │               │   └── UserFeignClient.java
│   │   │               ├── service/                 # 服务层
│   │   │               │   ├── AuthService.java
│   │   │               │   └── impl/
│   │   │               │       └── AuthServiceImpl.java
│   │   │               ├── util/                    # 工具类
│   │   │               │   └── JwtTokenUtil.java
│   │   │               └── vo/                      # 视图对象
│   │   │                   └── TokenVO.java
│   │   └── resources/
│   │       ├── application.yml                     # 应用配置
│   │       └── bootstrap.yml                       # 引导配置
│   └── test/                                       # 测试目录
└── pom.xml                                         # 项目依赖
```

## 四、功能说明

### 1. 用户认证
- 用户登录：验证用户名密码并生成JWT令牌
- 刷新令牌：使用刷新令牌获取新的访问令牌
- 用户登出：使当前令牌失效
- 密码修改：验证旧密码并更新为新密码

### 2. API接口

| 接口名称 | 请求方式 | 接口路径 | 接口说明 |
| ---- | ---- | ---- | ---- |
| 用户登录 | POST | /api/auth/login | 验证用户名密码并返回令牌信息 |
| 刷新令牌 | POST | /api/auth/refresh | 使用刷新令牌获取新的访问令牌 |
| 用户登出 | POST | /api/auth/logout | 使当前令牌失效 |
| 修改密码 | PUT | /api/auth/password | 验证旧密码并修改新密码 |

### 3. 认证流程

1. **登录流程**
   - 接收用户名和密码
   - 调用user-service验证用户信息
   - 生成访问令牌和刷新令牌
   - 将刷新令牌存入Redis
   - 返回令牌信息给客户端

2. **令牌刷新流程**
   - 接收刷新令牌
   - 验证刷新令牌的有效性
   - 从Redis中查询存储的刷新令牌
   - 生成新的访问令牌和刷新令牌
   - 将旧令牌加入黑名单
   - 更新Redis中的刷新令牌
   - 返回新的令牌信息

3. **登出流程**
   - 从请求头中提取令牌
   - 从令牌中获取用户ID
   - 从Redis中删除对应的刷新令牌

4. **修改密码流程**
   - 接收旧密码和新密码
   - 调用user-service验证旧密码
   - 调用user-service更新新密码
   - 登出用户（使当前令牌失效）

## 五、令牌管理

### JWT令牌结构
- 头部（Header）：算法和令牌类型
- 负载（Payload）：用户ID、用户名、角色、过期时间等信息
- 签名（Signature）：用于验证令牌的有效性

### 令牌类型
- 访问令牌（Access Token）：用于访问API，有效期短
- 刷新令牌（Refresh Token）：用于获取新的访问令牌，有效期长

### Redis键值设计
- 刷新令牌：`token:refresh:{userId}`
- 黑名单令牌：`token:blacklist:{token}`

## 六、开发进度

- [x] 项目基础结构搭建
- [x] JWT工具类开发
- [x] 用户认证服务接口及实现类开发
- [x] 认证控制器开发
- [x] 与用户服务的集成（Feign客户端）
- [x] 登录、刷新令牌功能实现
- [x] 登出功能实现
- [x] 修改密码功能实现
- [ ] 单元测试编写
- [ ] 集成测试编写
- [ ] 文档完善 