# 认证模块开发指南

## 一、目录结构

```
auth-service/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── ptu/
│   │   │           └── auth/
│   │   │               ├── config/         # 配置类
│   │   │               │   ├── JwtConfig.java     # JWT配置
│   │   │               │   ├── RedisConfig.java   # Redis配置
│   │   │               │   └── SwaggerConfig.java # Swagger配置
│   │   │               ├── controller/     # 控制器
│   │   │               │   └── AuthController.java
│   │   │               ├── dto/            # 数据传输对象
│   │   │               │   ├── ChangePasswordDTO.java
│   │   │               │   ├── LoginDTO.java
│   │   │               │   └── RefreshTokenDTO.java
│   │   │               ├── entity/         # 实体类
│   │   │               │   └── UserVO.java
│   │   │               ├── feign/          # Feign客户端
│   │   │               │   └── UserFeignClient.java
│   │   │               ├── service/        # 服务接口
│   │   │               │   ├── AuthService.java
│   │   │               │   └── impl/
│   │   │               │       └── AuthServiceImpl.java
│   │   │               ├── util/           # 工具类
│   │   │               │   └── JwtTokenUtil.java
│   │   │               ├── vo/             # 视图对象
│   │   │               │   └── TokenVO.java
│   │   │               └── AuthServiceApplication.java  # 启动类
│   │   └── resources/
│   │       ├── application.yml     # 应用配置
│   │       └── bootstrap.yml       # 引导配置
│   └── test/
│       └── java/                   # 测试代码
```

## 二、功能说明

### 1. 认证功能

#### 1.1 用户登录
- 接口：`POST /auth/login`
- 功能：用户登录并获取令牌
- 请求参数：用户名、密码
- 返回结果：访问令牌、刷新令牌、用户ID、用户名、过期时间

#### 1.2 刷新令牌
- 接口：`POST /auth/refresh`
- 功能：使用刷新令牌获取新的访问令牌
- 请求参数：刷新令牌
- 返回结果：新的访问令牌、刷新令牌、用户信息、过期时间

#### 1.3 退出登录
- 接口：`POST /auth/logout`
- 功能：用户退出登录
- 请求参数：无（从请求头Authorization获取令牌）
- 返回结果：操作结果

#### 1.4 修改密码
- 接口：`PUT /auth/password`
- 功能：修改用户密码
- 请求参数：旧密码、新密码
- 返回结果：操作结果

### 2. JWT功能

#### 2.1 JWT令牌生成
- 生成访问令牌和刷新令牌
- 访问令牌包含用户ID、用户名、角色等信息
- 刷新令牌包含用户ID和类型标识

#### 2.2 JWT令牌验证
- 验证令牌签名
- 检查令牌是否过期
- 解析令牌中的用户信息

### 3. 缓存管理

#### 3.1 令牌缓存
- 将刷新令牌存储在Redis中
- 维护令牌黑名单
- 管理令牌过期时间

## 三、技术实现

### 1. JWT认证流程

1. 用户登录：
   - 验证用户名和密码
   - 生成访问令牌和刷新令牌
   - 将刷新令牌存入Redis，设置过期时间
   - 返回令牌信息

2. 请求认证：
   - 从请求头中提取令牌
   - 验证令牌签名和过期时间
   - 检查令牌是否在黑名单中
   - 解析用户信息，进行授权

3. 刷新令牌：
   - 验证刷新令牌有效性
   - 检查Redis中是否存在对应刷新令牌
   - 生成新的访问令牌和刷新令牌
   - 将旧令牌加入黑名单
   - 更新Redis中的刷新令牌

4. 退出登录：
   - 从Redis中删除刷新令牌
   - 将访问令牌加入黑名单

### 2. 安全配置

- JWT密钥配置：通过配置文件设置密钥和过期时间
- Redis缓存配置：配置Redis连接和序列化方式
- Swagger配置：配置API文档生成

## 四、开发进度

| 功能 | 状态 | 完成时间 | 备注 |
| --- | --- | --- | --- |
| 基础依赖配置 | 已完成 | 2024-08-05 | - |
| JWT功能实现 | 已完成 | 2024-08-05 | - |
| 用户登录 | 已完成 | 2024-08-05 | - |
| 刷新令牌 | 已完成 | 2024-08-05 | - |
| 退出登录 | 已完成 | 2024-08-05 | - |
| 修改密码 | 待实现 | - | 需要调用user-service |

## 五、接口用例

### 1. 登录接口

#### 请求示例

```http
POST /auth/login HTTP/1.1
Content-Type: application/json

{
  "username": "zhangsan",
  "password": "password123"
}
```

#### 响应示例

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "userId": 1,
    "username": "zhangsan",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 3600
  }
}
```

### 2. 刷新令牌接口

#### 请求示例

```http
POST /auth/refresh HTTP/1.1
Content-Type: application/json

{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### 响应示例

```json
{
  "code": 200,
  "message": "刷新成功",
  "data": {
    "userId": 1,
    "username": "zhangsan",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 3600
  }
}
```

## 六、注意事项

1. JWT密钥需要妥善保管，避免泄露
2. 令牌过期时间要根据安全性要求进行配置，一般访问令牌较短，刷新令牌较长
3. 生产环境中应使用HTTPS传输令牌
4. Redis缓存要配置合理的过期时间，避免内存泄露
5. 认证模块需要与用户模块密切配合，确保用户数据一致性 