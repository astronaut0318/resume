# 模板模块开发指南

## 一、模块介绍

模板模块是简历系统的核心组成部分，负责模板的管理、分类、收藏和文件访问等功能。本模块提供RESTful风格的API接口，供前端和其他微服务调用。

## 二、技术选型

- Spring Boot 2.7.14
- Spring Cloud 2021.0.8
- MyBatis Plus 3.5.2
- Redis 6.0+
- MinIO 对象存储
- MySQL 8.0.28
- Knife4j/Swagger 接口文档
- **OnlyOffice Document Server**: 7.3.3+
  - 用途：实现文档在线预览与编辑
  - 部署方式：Docker容器化部署
  - 支持格式：Word(.docx/.doc)、Excel、PowerPoint等

## 三、目录结构

```
template-service/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── ptu/
│   │   │           └── template/
│   │   │               ├── TemplateServiceApplication.java  # 启动类
│   │   │               ├── common/                          # 公共类
│   │   │               │   ├── constants/                   # 常量定义
│   │   │               │   └── query/                       # 查询对象
│   │   │               ├── config/                          # 配置类
│   │   │               ├── controller/                      # 控制器
│   │   │               │   ├── TemplateController.java      # 模板控制器
│   │   │               │   ├── TemplateFileController.java  # 模板文件控制器
│   │   │               │   ├── TemplateCategoryController.java # 分类控制器
│   │   │               │   └── TemplateCollectionController.java # 收藏控制器
│   │   │               ├── entity/                          # 实体类
│   │   │               ├── mapper/                          # Mapper接口
│   │   │               ├── service/                         # 服务接口
│   │   │               │   └── impl/                        # 服务实现
│   │   │               └── vo/                              # 视图对象
│   │   └── resources/
│   │       ├── application.yml                             # 应用配置
│   │       ├── bootstrap.yml                               # 引导配置
│   │       └── mapper/                                     # MyBatis XML文件
│   └── test/                                               # 测试目录
└── pom.xml                                                # 项目依赖
```

## 四、功能说明

### 1. 模板管理

- 模板分页查询：支持按分类、价格、关键词过滤
- 模板详情查看：获取模板的详细信息
- 模板收藏/取消收藏：用户可收藏感兴趣的模板
- 模板分享：生成分享链接，未登录用户也可查看

### 2. 模板分类

- 分类列表查询：获取所有可用的模板分类
- 分类详情查询：获取分类的详细信息

### 3. 模板文件访问

- 文件预览：生成临时URL，用于预览模板文件
- 文件下载：直接下载模板文件

## 五、模板文件访问说明

### 1. MinIO存储配置

项目使用MinIO作为对象存储服务，用于存储模板文件。配置信息位于`application.yml`：

```yaml
# MinIO配置
minio:
  endpoint: http://localhost:9001
  access-key: minioadmin
  secret-key: minioadmin
  bucket: 
    template: resume-templates  # 模板文件存储桶
    thumbnail: resume-thumbnails  # 缩略图存储桶
```

### 2. 访问模板文件

#### 2.1 获取预览URL

```http
GET /template-files/{templateId}/preview-url
```

- 返回一个临时访问URL（有效期30分钟），可直接在浏览器中打开预览
- 适用于PDF、Word等文档文件
- 每次预览会增加模板下载计数

#### 2.2 下载模板文件

```http
GET /template-files/{templateId}/download
```

- 直接返回文件流，触发浏览器下载
- 设置了适当的Content-Type和Content-Disposition头
- 每次下载会增加模板下载计数

### 3. 使用示例

```javascript
// 前端预览示例
async function previewTemplate(templateId) {
  const response = await fetch(`/api/templates/template-files/${templateId}/preview-url`);
  const data = await response.json();
  if (data.code === 200) {
    // 在新窗口打开预览URL
    window.open(data.data, '_blank');
  } else {
    alert('获取预览链接失败：' + data.message);
  }
}

// 前端下载示例
function downloadTemplate(templateId) {
  // 直接触发下载
  window.location.href = `/api/templates/template-files/${templateId}/download`;
}
```

### 4. 接口测试

#### 通过网关访问

当部署完成后，可以通过以下方式测试接口：

**a. 预览URL获取**
```
GET http://localhost:9000/api/templates/template-files/{templateId}/preview-url
```

**b. 文件下载**
```
GET http://localhost:9000/api/templates/template-files/{templateId}/download
```

#### 直接访问服务

在开发环境中，也可以直接访问模板服务测试：

**a. 预览URL获取**
```
GET http://localhost:8004/template-files/{templateId}/preview-url
```

**b. 文件下载**
```
GET http://localhost:8004/template-files/{templateId}/download
```

#### 使用Postman测试

1. 创建GET请求到预览URL接口
2. 发送请求后获取返回的URL
3. 在浏览器中访问此URL，即可预览文件

## 七、常见问题及解决方案

### 1. MinIO连接问题

**问题**：无法连接到MinIO服务器。

**解决方案**：
- 检查MinIO服务是否正常运行（默认端口9001，控制台9000）
- 验证配置文件中的endpoint、access-key和secret-key是否正确
- 确保网络环境允许应用服务器访问MinIO服务器

### 2. 模板文件不存在错误

**问题**：访问模板文件时提示"模板文件不存在"。

**解决方案**：
- 检查数据库中模板记录的filePath字段是否正确
- 验证MinIO中是否存在对应的文件
- 使用MinIO控制台上传文件并更新数据库记录

### 3. 临时URL生成失败

**问题**：生成预览URL时报错。

**解决方案**：
- 检查MinIO客户端配置
- 验证模板存储桶(bucket)是否存在
- 确认MinIO服务器权限设置是否允许presign URL操作

### 4. 文件下载中文名乱码

**问题**：下载的文件名包含中文时出现乱码。

**解决方案**：
- 确保使用URLEncoder正确编码文件名
- 在Content-Disposition头中使用RFC 5987编码
- 检查浏览器编码设置

### 5. 无法预览特定格式文件

**问题**：某些格式的文件无法在浏览器中直接预览。

**解决方案**：
- PDF和图片格式通常可直接预览
- Word、Excel等文档可能需要安装相应插件或使用Office Online预览
- 对于不支持预览的格式，引导用户下载后本地查看

## 八、开发进度

- [x] 项目基础结构搭建
- [x] 模板管理功能开发
- [x] 模板分类功能开发
- [x] 模板收藏功能开发
- [x] MinIO存储集成
- [x] 模板文件访问接口开发
- [x] 接口文档完善
- [ ] 单元测试编写
- [ ] 集成测试编写
- [ ] 性能优化 

前端 <---> API网关 <---> 模板服务/文件服务 <---> OnlyOffice服务
  ^                              ^                    ^
  |                              |                    |
  +------------------------------+--------------------+
           数据交互流程 